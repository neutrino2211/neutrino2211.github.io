---
comments: 0
reactions: 0
views: 0
published_at: 2024-04-04T20:44:51Z
cover_image: none
title: "Technical Analysis: Async Rat ðŸ‘¾"
published: true
description: "A technical analysis of the AsyncRat remote access trojan that rose in 2021 and has managed to stay relevant till now (Q1 2024)"
tags: "#reverseengineering #cysec #infostealer asyncrat analysis reverse engineering info stealer"
devto_link: 
---

In today's age of nation state hackers and advanced cyberwarfare, AsyncRat seems like a clown at a funeral. It is developed in the open on [Github](https://github.com/NYAN-x-CAT/AsyncRAT-C-Sharp/tree/master) because it is marketed as an open-source "Remote Administration Tool".

Not unlike the [ps2exe](https://github.com/MScholtes/PS2EXE) program that was used prolifically by cyber criminals to convert powershell malware scripts to EXE. This time it feels different as when ps2exe had it's programs marked as malware by popular anti-malware vendors, the community went up in arms about it's legitimate use but it seems AsyncRat is not bothered by the potential of being marked as malware, almost as if that was the point the whole time ðŸ¤”

## The Code

AsyncRat is built from two angles, the server and the client, just like other RATs but AsyncRat has a few implementation details.

![Source Tree](https://lh7-us.googleusercontent.com/5hi1xvbOi61l1bM8w5S7jQjcWXTjs2ulD3VJPp3rT__lOMPo3hYtUAu2aawtdx6s5h3UkKMeF3JE8mU6Vf8HkZ4cf_GMPOcAEovifWnGEc2V9JDko2LbOPUPtJzb9GiDAwuZRYCzrl2Ek7sU5FptZfI)

As always it has the client/server but uses MessagePack to facilitate communication within the two and has a Plugin system to activate certain capabilities as part of the process.

It has a somewhat standard server architecture but there are additional functionalities like sending Plugin DLLs.

The client though is where all the âœ¨MAGICâœ¨ happens. There are a few interesting things to look at within its source code which will be broken down.

## 1. Persistence

The AsyncRat client achieves persistence by one of two methods.

  - Creating a scheduled task on logon if the current user is an Admin.

  - Adding the program to the current user's Software\Microsoft\Windows\CurrentVersion\Run\ registry key.


The keen eyed readers among you would have noticed that the Registry Key path is reversed, I certainly did not notice this until it was pointed out to me in a blog post I was linked to during the research of this specific topic.

The registry key is reversed to avoid static analysis as most AV software are wary of program that try to do anything with the Run key.

![Persistence Commands and RegKey](https://lh7-us.googleusercontent.com/v1VwWwwfMEDKnQSF76M_WIxnjuVcb5aWTwkwEuq24tqgR4F9NL-osp_wNuRQ9xBB_k14sg51WtnfR_3NmMNOAQWYS9WSV6kpcCbUui2Azm0YwWQ1vweE1-_z8uEHJXYLLiCy3t2bQM32tlGc9WF-7HI)

## 2. AV Detection

The Client detects Antivirus programs by enumerating all values in the machine's SecurityCenter2 registry key.

![AntiVirus Detection](https://lh7-us.googleusercontent.com/8JCUnZZnpd-eeLf3U8WXQkw6ThK2DcANCrpm5cwvTerqulzeOIoZ_6IKIeQrpG1-QqHLUsIYT6MVaNkchkNS5TRtPGRzgH3cgHeym5lwMzrFVV2i6ZUNGjMODFjXTDF8XDI6EpGotERH31XyTx57L5A)

The client itself does not do anything in particular with this data, instead it sends it to the server where it is listed as part of the identifiers for that specific infected machine.

![ID Sender Info MSGPACK](https://lh7-us.googleusercontent.com/NXRa8mR4IYPvSVZu1nam07Nc1dC9ug8vkRVm_1MHiUXjZCFoHznyUzcIlbCrPdcu6TGY4_mRu-9-GrOMR6jG_OEQv_WyqKkJSYBGnTa657vFVdUh6xaF14dg0YV8xt80GsfoMrt5D6QiOkt6X53BqgQ)

I personally think this was also done to help the attacker pick and choose what plugins to deploy on the infected machine as some plugins might be too invasive and would get flagged by an AV software.

## 3. Hardware Identification

The client generates a unique ID that is sent along with the other identifiable information to the server as shown above, but the HWID parameter is itself a unique identifier for the machine. I am not too sure as to why they need both identifiable information and a unique ID but apparently they do, so let's look at that.

The HardwareID is generated by hashing a concatenation of the Machine's processor count, the compromised user's username, the machine's name, the OS version and the total size of the root disk using the MD5 algorithm.

![HWID Algorithm](https://lh7-us.googleusercontent.com/seQfN44mESHzNryRjO0kJDrQvTg4FC25NDVHOvQEVkQo0jKEZbLWEnnU30JHHXntolS7uTl2XCD-byhEF8CtCSc5TF6Y_qY7ytqtOqelP-TxKQdUjGVjYJs2lZ5qvIbLMAaItZagqOkOHy2ZSF-VZn8)

## 4. Plugins

AsyncRAT contains multiple plugins that run multiple payloads, the way it is handled is by sending the whole plugin DLL as part of a MessagePack message. There are two ways the client handles plugins.

- ### Unsaved Plugin
    A plugin is sent from the server with the intention of being executed being in-memory while the client is online. The client checks if the plugin was to be executed is already installed on the system, if it is not, the DLL is requested from the server.
    
    When the server sends back the DLL, the client saves the plugin then executes it in-memory by decoding the assembly.
    
    **!["In-Memory" plugin handler](https://lh7-us.googleusercontent.com/sp8zpWWOiTBD_lxW0VRUIHeYkIZJH8UME0vY0wwpjacDg2S9J3cbMsmglSpDRl0b35GPIOTpqAu2dAhooj11JdvrfqcHmOD-IPP__D9IHiFqy59aaZaekyRZYRgJrwovEJAXZreWOIDwDePD3FbMobY)**
    **![Invoke Method](https://lh7-us.googleusercontent.com/ZgZzPz8wjd4OgdipDr_vaxRCIE1O9LzQp521wl2hFJag0LY5B2A4yiJ41dghStHaTeOQj6j01GQ0Lpyb34VvB4cTNY4EU-OXvq7-VsMeTdcb8CZLo4XKdyxL63uCvoryrfpIh6oOIuPJgpdOY6wDsqc)**

- ### Saved Plugin
    If the plugin is saved, the DLL is executed without an intermediate step
    
    **![Saved Plugin](https://lh7-us.googleusercontent.com/GFdl6E9UaEAj-KxfdFSRd-_7VDbG4SRKmLY_59wLL0Sk_Bl4AiYzvIRJtx2LT7Qc97AZSVGJZn7ZUTeiTe3b-5nRHWN4hGCCttaJHjPwdc7sQOgJ4_ABIFfxUOUwJRin38w3L0kHJP0s1WDcvsvmtcY)**
    ![Invoke Method](https://lh7-us.googleusercontent.com/ZgZzPz8wjd4OgdipDr_vaxRCIE1O9LzQp521wl2hFJag0LY5B2A4yiJ41dghStHaTeOQj6j01GQ0Lpyb34VvB4cTNY4EU-OXvq7-VsMeTdcb8CZLo4XKdyxL63uCvoryrfpIh6oOIuPJgpdOY6wDsqc)

## The Report

This analysis was done as part of a larger report (not yet published) I worked on with my colleagues at [Cyberplural](https://cyberplural.com) and contains more work from me and other talented personnel at the company.